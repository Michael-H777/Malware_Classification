from configs import *
from packages import *

import os
from io import BytesIO
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from PIL import Image


class DataScaler:
    
    def __init__(self, *, domain_min=0, domain_max=0, target_min=-1, target_max=1):
        self.domain_min = domain_min
        self.domain_range = domain_max - domain_min
        
        self.target_min = target_min
        self.target_range = target_max - target_min
        
    def get_domain_stats(self, folder_path):
        domain_min, domain_max = np.inf, -np.inf
        for filename in os.listdir(folder_path):
            data = tifffile.imread(f'{folder_path}/{filename}')
            domain_min = np.min(domain_min, data.min())
            domain_max = np.max(domain_max, data.max())
        # update stats
        self.domain_min = domain_min
        self.domain_range = domain_max - domain_min
        return None 

    def to_target(self, input_data):
        position = (input_data - self.domain_min) / (self.domain_range)
        result = (self.target_range * position) + self.target_min
        return np.float32(result)
    
    def to_domain(self, input_data): 
        position = (input_data - self.target_min) / self.target_range
        result = position * self.domain_range + self.domain_min
        return np.float32(result)


def to_image():

    # note: this is just an example of how to turn a specific bytes file into an image. To automate turning all
    # bytes files into images, just add a for loop to iterate through all of the bytes files in the train folder.

    # load in a bytes file and turn it into a pandas data frame
    file = open('train/0A32eTdBKayjCWhZqDOQ.bytes', 'r')
    lines = file.readlines()
    df = pd.DataFrame(lines, columns=['spaces'])

    # remove the first 9 characters, as they are irrelevant and turn each space into a separate column
    df2 = df.spaces.apply(lambda x: x[9:].rstrip()).str.split(' ', expand=True)

    # There are a few None values and '??' values that we cannot work with. For now we will just fill them in with '00'
    df2 = df2.replace('??','00')
    df2 = df2.fillna(value='00')

    # convert all of the hex values into base 16 integer values
    for x in range(16):
        df2.iloc[:,x] = df2.iloc[:,x].apply(lambda x: int(x, 16))

    # Turn the dataframe into an image with (256,256) dimensions, using the antialias method to resize it
    img = Image.fromarray(np.uint8(df2.to_numpy()))
    img.resize((256,256),Image.ANTIALIAS)

    # this new final image can be saved into a directory for all of the images



def create_h5_dataset(patches, name_header, h5file, augment_times=0):
    pass


def make_model_data(*, augment_times=0, train_size=1500, val_size=50): 
    pass


def augment_data(image, mode):
    # all rotation is counter clock wise 
    out = image
    if mode == 1:
        # flip up and down
        out = np.flipud(out)
    elif mode == 2:
        # rotate 90 degree
        out = np.rot90(out)
    elif mode == 3:
        # rotate 90 degree and flip up and down
        out = np.rot90(out)
        out = np.flipud(out)
    elif mode == 4:
        # rotate 180 degree
        out = np.rot90(out, k=2)
    elif mode == 5:
        # rotate 180 degree and flip
        out = np.rot90(out, k=2)
        out = np.flipud(out)
    elif mode == 6:
        # rotate 270 degree
        out = np.rot90(out, k=3)
    elif mode == 7:
        # rotate 270 degree and flip
        out = np.rot90(out, k=3)
        out = np.flipud(out)
    return np.transpose(out)


